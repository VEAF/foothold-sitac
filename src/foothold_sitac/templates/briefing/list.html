{% extends "base.html" %}

{% block title %}Briefings{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="{{ static_url('css/cards.css') }}">
<link rel="stylesheet" href="{{ static_url('css/briefing.css') }}">
{% endblock %}

{% block body_class %}bg-gradient-dark{% endblock %}

{% block content %}
<div class="container briefing-container">
    <div class="briefing-header">
        <h1><i class="fa-solid fa-file-lines"></i> Briefings</h1>
        <button onclick="openNewBriefingModal()" class="btn btn-primary">
            <i class="fa-solid fa-plus"></i> New Briefing
        </button>
    </div>

    {% if servers|length > 0 %}
    <div class="filter-bar">
        <span class="filter-label">Filter by server:</span>
        <a href="{{ request.url_for('briefing_list') }}" class="filter-chip {% if not server_filter %}active{% endif %}">All</a>
        {% for s in servers %}
        <a href="{{ request.url_for('briefing_list') }}?server={{ s }}" class="filter-chip {% if server_filter == s %}active{% endif %}">{{ s }}</a>
        {% endfor %}
    </div>
    {% endif %}

    {% if briefings %}
    <div class="briefing-list">
        {% for briefing in briefings %}
        <div class="briefing-card-wrapper" data-id="{{ briefing.id }}">
            <a href="{{ request.url_for('briefing_view', briefing_id=briefing.id) }}" class="briefing-card">
                <div class="briefing-card-header">
                    <h3 class="briefing-title">{{ briefing.title }}</h3>
                    <span class="server-badge">{{ briefing.server_name }}</span>
                </div>
                <div class="briefing-card-meta">
                    <span><i class="fa-solid fa-crosshairs"></i> {{ briefing.objectives|length }} objectives</span>
                    <span><i class="fa-solid fa-layer-group"></i> {{ briefing.packages|length }} packages</span>
                    <span><i class="fa-solid fa-clock"></i> {{ briefing.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
            </a>
            <a href="#" class="edit-link" title="Edit briefing"><i class="fa-solid fa-pen"></i></a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fa-solid fa-file-lines"></i>
        <p>No briefings yet</p>
        <button onclick="openNewBriefingModal()" class="btn btn-primary">Create your first briefing</button>
    </div>
    {% endif %}

    <div class="back-link">
        <a class="btn btn-secondary" href="{{ request.url_for('foothold_servers') }}"><i class="fa-solid fa-arrow-left"></i> Back to servers</a>
    </div>
</div>

<!-- New Briefing Modal -->
<div id="new-briefing-modal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'new-briefing-modal')">
    <div class="modal-content zone-modal">
        <button class="modal-close" onclick="closeNewBriefingModal()">&times;</button>
        <h3><i class="fa-solid fa-plus"></i> New Briefing</h3>
        <form id="new-briefing-form" onsubmit="submitNewBriefing(event)">
            <div class="form-group">
                <label for="server_name">Server</label>
                <select id="server_name" name="server_name" required>
                    <option value="">Select a server...</option>
                    {% for s in servers %}
                    <option value="{{ s }}" {% if server_filter == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="title">Briefing Title</label>
                <input type="text" id="title" name="title" placeholder="e.g., Operation Desert Storm - Day 1" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="mission_date">Mission Date</label>
                    <input type="date" id="mission_date" name="mission_date">
                </div>
                <div class="form-group">
                    <label for="mission_time">Mission Time</label>
                    <input type="text" id="mission_time" name="mission_time" placeholder="e.g., 0800L">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeNewBriefingModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fa-solid fa-check"></i> Create Briefing</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Check localStorage for edit tokens and show edit buttons
document.addEventListener('DOMContentLoaded', function() {
    var tokens = {};
    try {
        tokens = JSON.parse(localStorage.getItem('briefing_edit_tokens') || '{}');
    } catch (e) {
        tokens = {};
    }

    document.querySelectorAll('.briefing-card-wrapper').forEach(function(wrapper) {
        var id = wrapper.dataset.id;
        var editLink = wrapper.querySelector('.edit-link');

        if (tokens[id]) {
            // User has edit token for this briefing
            wrapper.classList.add('has-edit-token');
            editLink.href = '/foothold/briefing/' + id + '/edit?token=' + tokens[id];
            editLink.style.display = 'flex';

            // Add badge to title
            var title = wrapper.querySelector('.briefing-title');
            var badge = document.createElement('span');
            badge.className = 'badge badge-primary editable-badge';
            badge.innerHTML = '<i class="fa-solid fa-pen"></i>';
            badge.title = 'You can edit this briefing';
            title.appendChild(badge);
        } else {
            // No token, hide edit link
            editLink.style.display = 'none';
        }
    });

    // Set default date to today
    var dateInput = document.getElementById('mission_date');
    if (dateInput && !dateInput.value) {
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = yyyy + '-' + mm + '-' + dd;
    }
});

// Modal functions
function openNewBriefingModal() {
    document.getElementById('new-briefing-modal').classList.add('visible');
}

function closeNewBriefingModal() {
    document.getElementById('new-briefing-modal').classList.remove('visible');
}

function closeModalOnOverlay(event, modalId) {
    if (event.target.id === modalId) {
        document.getElementById(modalId).classList.remove('visible');
    }
}

async function submitNewBriefing(event) {
    event.preventDefault();

    var data = {
        server_name: document.getElementById('server_name').value,
        title: document.getElementById('title').value,
        mission_date: document.getElementById('mission_date').value || null,
        mission_time: document.getElementById('mission_time').value || null
    };

    try {
        var response = await fetch('/api/briefing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            throw new Error('Failed to create briefing');
        }

        var result = await response.json();
        // Redirect to edit page with token
        window.location.href = result.links.edit_url;
    } catch (err) {
        alert('Error creating briefing: ' + err.message);
    }
}
</script>
{% endblock %}
