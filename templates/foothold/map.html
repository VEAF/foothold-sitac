{% extends "base.html" %}

{% block title %}Map{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="/static/css/navbar.css">
<link rel="stylesheet" href="/static/css/map.css">
<link rel="stylesheet" href="/static/css/modals.css">
{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="navbar">
    <span class="navbar-brand"><i class="fa-solid fa-server"></i> {{ server }}</span>
    <div class="navbar-links">
        <a href="#" onclick="openModal('players'); return false;"><i class="fa-solid fa-ranking-star"></i><span class="navbar-link-label"> Player Rankings</span><span class="navbar-tooltip">View player statistics and rankings</span></a>
        <a href="#" onclick="openModal('missions'); return false;" id="missions-link" class="{% if sitac.missions|length == 0 %}disabled{% endif %}"><i class="fa-solid fa-crosshairs"></i><span class="navbar-link-label"> Missions</span><span class="navbar-badge" id="missions-badge">{{ sitac.missions|length }}</span><span class="navbar-tooltip">Active missions on the server</span></a>
        <span class="navbar-item" id="ejected-pilots-info" onclick="openModal('ejected')" style="cursor: pointer;"><i class="fa-solid fa-parachute-box"></i><span class="navbar-link-label"> Ejected</span><span class="navbar-badge {% if sitac.ejected_pilots|length > 0 %}navbar-badge-orange{% else %}navbar-badge-gray{% endif %}" id="ejected-pilots-count">{{ sitac.ejected_pilots|length }}</span><span class="navbar-tooltip">Ejected pilots awaiting rescue</span></span>
        <span class="navbar-item" onclick="openModal('zones')" style="cursor: pointer;"><i class="fa-solid fa-flag"></i><span class="navbar-link-label"> Objectives</span><span class="navbar-badge"><span id="progress-value">{{ "%.0f"|format(progress) }}</span>%</span><span class="navbar-tooltip">Campaign progress and zone status</span></span>
        <span class="navbar-item" onclick="openSettingsModal()" style="cursor: pointer;"><i class="fa-solid fa-gear"></i><span class="navbar-link-label"> Settings</span><span class="navbar-tooltip">Display settings</span></span>
        <a href="{{ request.url_for('foothold_servers') }}"><i class="fa-solid fa-list"></i><span class="navbar-link-label"> Servers</span><span class="navbar-tooltip">Back to server list</span></a>
    </div>
</nav>

<!-- Map -->
<div id="map"></div>

<!-- Freshness widget -->
<div id="freshness-widget" class="fresh">
    <span id="freshness-icon">üïê</span>
    <span id="countdown">30s</span>
    <span class="tooltip" id="freshness-tooltip">Refresh in 30s</span>
</div>

<!-- Cursor coordinates widget -->
<div id="cursor-coords-widget">
    <span id="cursor-coords"></span>
</div>

<!-- Modal -->
<div id="modal-overlay" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div id="modal-body">
            <div class="modal-loading">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="/static/js/coords.js"></script>
<script src="/static/js/modals.js"></script>
<script src="/static/js/map.js"></script>
<script>
    // Set modal endpoints
    modalEndpoints = {
        players: '{{ request.url_for("foothold_players_modal", server=server) }}',
        zones: '{{ request.url_for("foothold_zones_modal", server=server) }}',
        missions: '{{ request.url_for("foothold_missions_modal", server=server) }}',
        ejected: '{{ request.url_for("foothold_ejected_modal", server=server) }}'
    };

    // Set map configuration
    map_center = JSON.parse('{{ center }}');
    map_options = JSON.parse('{{ config.map.model_dump() | tojson }}');
    mapDataEndpoint = '{{ request.url_for("foothold_get_map_data", server=server) }}';

    // Initialize map and start refresh timer
    initMap();
    startRefreshTimer();
</script>
{% endblock %}
